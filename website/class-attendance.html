<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/css/class-attendance.css" type="text/css">
    <title>Class Attendance</title>
</head>
<style>

</style>
<body>
<header>
    <div class="holder">
        <img class="dots" src="static/img/dots.png" alt="dots">
        <a href="">&larr; Go back</a>
    </div>
    <img class="logo" src="static/img/aas-logo.png" alt="logo">
</header>
<div class="main-part">
    <div class="main-header invisible">
        <h1>Course name</h1>
    </div>
    <div class="class-description">
        <div class="top-class-description">
            <p>Date</p>
        </div>
        <div class="bottom-class-description">
            <p>Class has started</p>
            <p>Time of the class - 00:00:00</p>
        </div>
    </div>
    <table>
        <thead>
        <tr>
            <th>Student ID</th>
            <th>First name</th>
            <th>Last name</th>
            <th>Presence</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <div class="button-area">
        <input type="submit" value="End checking prematurely" name="end_checking_prematurely" id="end_checking_prematurely" class="test">
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlClassID = urlParams.get('classID');

        const endCheckingButton = document.getElementById('end_checking_prematurely');

        // Add event listener to the "End checking prematurely" button
        endCheckingButton.addEventListener('click', function() {
            const table = document.querySelector('table');
            const rows = table.getElementsByTagName('tr');

            // Loop through each row in the table body
            for (let i = 1; i < rows.length; i++) {
                const presenceCell = rows[i].getElementsByTagName('td')[3];

                // Check if the cell contains "Mark excuse"
                if (presenceCell && presenceCell.innerText.trim() === 'Mark excuse') {
                    // Change text to "Absent"
                    presenceCell.innerText = 'Absent';

                    // Change background color to red
                    presenceCell.style.backgroundColor = '#DC7777'; // Red color
                }
            }

            // Change button text to "Save results"
            endCheckingButton.value = 'Save results';

            endCheckingButton.onclick = function() {
                window.location.href = '';
            };
        });

        fetch(`/api/web/attendance/by_class?classID=${urlClassID}`)
            .then(res => res.json())
            .then(data => {
                console.log(data)
                const tbody = document.querySelector('tbody');
                data.forEach(entry => {
                    const tr = document.createElement('tr');

                    const studentIdCell = document.createElement('td');
                    studentIdCell.textContent = entry.student.id;
                    tr.appendChild(studentIdCell);

                    const firstNameCell = document.createElement('td');
                    firstNameCell.textContent = entry.student.first_name;
                    tr.appendChild(firstNameCell);

                    const lastNameCell = document.createElement('td');
                    lastNameCell.textContent = entry.student.last_name;
                    tr.appendChild(lastNameCell);


                    const presenceCell = document.createElement('td');
                    presenceCell.className = 'white';

                    const select = document.createElement('select');
                    setColors(presenceCell, select, entry.status);
                    select.innerHTML = `
                        <option value="0" ${entry.status === "0" ? "selected" : ""}>Unmarked</option>
                        <option value="1" ${entry.status === "1" ? "selected" : ""}>Present</option>
                        <option value="2" ${entry.status === "2" ? "selected" : ""}>Absent</option>
                        <option value="3" ${entry.status === "3" ? "selected" : ""}>Excused</option>
                    `;

                    // Append dropdown to cell
                    presenceCell.appendChild(select);

                    // Event listener for dropdown change
                    select.addEventListener('change', function() {
                        const newStatus = select.value;
                        updateStatus(entry.student, newStatus, urlClassID);
                        setColors(presenceCell, select, newStatus);
                        console.log(select.value)
                        setColors()
                    });

                    tr.appendChild(presenceCell);
                    tbody.appendChild(tr);
                })
            })
            .catch(error => console.error('Error fetching courses:', error));

        function updateStatus(student, newStatus, classId) {
            fetch(`/api/web/attendance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    class_id: parseInt(classId),
                    student: student,
                    status: newStatus,
                    time: "0000-00-00 00:00:00"
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update attendance status');
                    } else {
                        console.log('Status updated successfully');
                    }
                })
                .catch(error => {
                    console.error('Error updating attendance status:', error);
                });
        }

        function setColors(cell, select, status) {
            switch (status) {
                    case "1":
                        cell.className = "green"
                        select.className = "green"
                        break
                    case "2":
                        cell.className = "red"
                        select.className = "red"
                        break
                    case "3":
                        cell.className = "grey"
                        select.className = "grey"
                        break
                    default:
                        cell.className = "white"
                        select.className = "white"
            }
        }
    });
</script>
</body>
</html>

