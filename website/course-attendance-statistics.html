<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Attendance</title>
    <link rel="stylesheet" href="/static/css/course-attendance-statistics.css" type="text/css">
</head>
<body>
<header>
    <div class="holder">
        <img class="dots" src="/static/img/dots.png" alt="dots">
        <a href="">&larr; Go back</a>
    </div>
    <img class="logo" src="/static/img/aas-logo.png" alt="logo">
</header>
<div class="main-part">
    <div class="main-header hidden">
        <h1>Course name</h1>
    </div>
    <div class="sub-header">
        <div><img src="/static/img/statistics.png"></div>
        <div><h2>Statistics</h2></div>
    </div>
    <div class="search-bar">
        <div class="search-bar-border">
            <input type="text" placeholder="Search a student">
        </div>
    </div>
    <table>
        <thead>
        <tr>
            <th>Student ID</th>
            <th>First name</th>
            <th>Last name</th>
            <th>Attendance Percentage</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const courseID = urlParams.get('courseID');

    fetch(`/api/web/courses`)
        .then(res => res.json())
        .then(data => {
            const courses = data.courses;

            courses.forEach(course => {
                if (course.id == courseID) {
                    console.log("Course: ", course.name);
                    const mainHeaderElement = document.querySelector('.main-header');
                    mainHeaderElement.classList.remove('hidden')
                    const h1Element = mainHeaderElement.querySelector('h1');
                    h1Element.innerText = course.name;
                }
            })
        })
        .catch(error => console.error('Error showing course name:', error));

    fetch(`/api/web/attendance/by_course?courseID=${courseID}`)
        .then(res => res.json())
        .then(data => {
            const attendanceData = data;
            const percentages = calculateStatusPercentage(attendanceData);
            const tbody = document.querySelector('tbody');

            Object.keys(percentages).forEach(studentID => {
                const studentData = attendanceData.find(entry => entry.student.id == studentID);
                const tr = document.createElement('tr');

                const studentIdCell = document.createElement('td');
                studentIdCell.textContent = studentData.student.id;
                tr.appendChild(studentIdCell);

                const firstNameCell = document.createElement('td');
                firstNameCell.textContent = studentData.student.first_name;
                tr.appendChild(firstNameCell);

                const lastNameCell = document.createElement('td');
                lastNameCell.textContent = studentData.student.last_name;
                tr.appendChild(lastNameCell);

                const presenceCell = document.createElement('td');
                presenceCell.textContent = percentages[studentID] + "%";
                tr.appendChild(presenceCell);

                tbody.appendChild(tr);
                if (percentages[studentID] >= 80) {
                    presenceCell.className = "green"
                } else {
                    presenceCell.className = "red"
                }
            });
        })
        .catch(error => console.error('Error fetching attendance by course:', error));

    function calculateStatusPercentage(items) {
        const counts = {};

        items.forEach(item => {
            const studentID = item.student.id;
            const status = parseInt(item.status);

            if (!counts[studentID]) {
                counts[studentID] = { total: 0, status1Count: 0 };
            }

            counts[studentID].total++;
            if (status === 1 || status === 3) {
                counts[studentID].status1Count++;
            }
        });

        const percentages = {};
        Object.keys(counts).forEach(studentID => {
            const count = counts[studentID];
            percentages[studentID] = Math.floor((count.status1Count / count.total) * 100);
        });

        return percentages;
    }
</script>
</body>
</html>
